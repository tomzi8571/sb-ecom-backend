name: Render Keep-Alive (ping + optional redeploy)

# Keeps a Render service awake by periodically pinging the public URL or
# triggering the Render redeploy hook. Adjust the cron frequency to suit your needs.

on:
  schedule:
    - cron: '*/10 * * * *' # every 10 minutes — change as needed
  workflow_dispatch: {}

jobs:
  keep-alive:
    # Use `ubuntu-latest` for GitHub-hosted runners. If you prefer a self-hosted runner
    # change this to: runs-on: [self-hosted, linux, keepalive]
    runs-on: ubuntu-latest

    steps:
      - name: Run keep-alive loop (10 pings, 1 per minute)
        env:
          SERVICE_WEB_URL: ${{ secrets.SERVICE_WEB_URL }}
        run: |
          # exit on unset vars and non-zero commands; pipefail helps catch curl failures
          set -euo pipefail

          if [ -z "${SERVICE_WEB_URL:-}" ]; then
            echo "Missing secret SERVICE_WEB_URL. Create it at Settings → Secrets and variables → Actions.";
            exit 1;
          fi

          # Build the full URL and ensure we don't have a trailing slash duplication
          KEEP_ALIVE_URL="${SERVICE_WEB_URL%/}/api/public/products"

          echo "Starting keep-alive to ${KEEP_ALIVE_URL} (10 pings, 1 per minute)"

          FAILURES=0
          for i in $(seq 1 10); do
            echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") Ping #$i"
            if ! curl -sSf --max-time 15 "$KEEP_ALIVE_URL" >/dev/null; then
              echo "Ping #$i failed"
              FAILURES=$((FAILURES+1))
            else
              echo "Ping #$i succeeded"
            fi

            # Sleep only between pings, not after the last one
            if [ "$i" -lt 10 ]; then
              sleep 60
            fi
          done

          if [ "$FAILURES" -gt 0 ]; then
            echo "${FAILURES} ping(s) failed"; exit 1;
          fi

          echo "All pings succeeded"

#      - name: Optional: Trigger Render redeploy hook
#        if: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
#        env:
#          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
#        run: |
#          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
#            echo "RENDER_DEPLOY_HOOK_URL secret not set; skipping redeploy.";
#            exit 0;
#          fi
#
#          echo "Calling Render redeploy hook"
#          curl -sSf "$RENDER_DEPLOY_HOOK_URL" || { echo "Redeploy webhook call failed"; exit 1; }

# Notes:
# - Create the repository secrets used above at: Settings → Secrets and variables → Actions
#   * SERVICE_WEB_URL: the public URL of the Render service (https://your-service.onrender.com or custom domain)
#   * RENDER_DEPLOY_HOOK_URL (optional): the deploy webhook URL Render provides when you create a "Deploy Hook" for the service
# - If you want the job to run on a self-hosted runner, register a runner in your repository or organization,
#   add a label such as `keepalive`, and set `runs-on: [self-hosted, linux, keepalive]`.
# - Avoid overly aggressive cron schedules; hitting the service every minute is usually unnecessary and may violate Render's acceptable use.
# - If a more authoritative approach is required (triggering a specific image tag deploy), use the Render REST API with `RENDER_API_KEY` and `RENDER_SERVICE_ID` secrets instead of the webhook.
